# 						蓝牙原理及软件开发

## 1.蓝牙原理

### 1.1蓝牙概述

 蓝牙，是一种支持设备短距离通信（一般10m内）的无线电技术。能在包括移动电话、PDA、无线耳机、笔记本电脑、相关外设等众多设备之间进行无线信息交换。利用“蓝牙”技术，能够有效地简化移动通信终端设备之间的通信，也能够成功地简化设备与因特网Internet之间的通信，从而数据传输变得更加迅速高效，为无线通信拓宽道路。蓝牙采用分散式网络结构以及快跳频和短包技术，支持点对点及点对多点通信，工作在全球通用的2.4GHz ISM（即工业、科学、医学）频段。

蓝牙的技术特点如下：

（1）、工作频段：2.4GHz的工科医（ISM）频段，无需申请许可证。大多数国家使用79个频点，载频为(2402+k)MHz（k=0，1, 2…78），载频间隔1MHz。采用TDD时分双工方式。
（2）、传输速率：1Mb/s。
（3）、调试方式：BT=0.5的GFSK调制，调制指数为0.28-0.35。
（4）、采用跳频技术：跳频速率为1600跳/秒，在建链时（包括寻呼和查询）提高为3200跳/秒。蓝牙通过快跳频和短分组技术减少同频干扰，保证传输的可靠性。
（5）、语音调制方式：连续可变斜率增量调制（CVSD，ContinuousVariable Slope Delta Modulation），抗衰落性强，即使误码率达到4%，话音质量也可接受。
（6）、支持电路交换和分组交换业务：蓝牙支持实时的同步定向联接（SCO链路）和非实时的异步不定向联接（ACL链路），前者主要传送语音等实时性强的信息，后者以数据包为主。语音和数据可以单独或同时传输。蓝牙支持一个异步数据通道，或三个并发的同步话音通道，或同时传送异步数据和同步话音的通道。每个话音通道支持64kbps的同步话音；异步通道支持723.2/57.6kbps的非对称双工通信或433.9kbps的对称全双工通信。
（7）、支持点对点及点对多点通信：蓝牙设备按特定方式可组成两种网络：微微网(Piconet)和分布式网络(Scatternet)，其中微微网的建立由两台设备的连接开始，最多可由八台设备组成。在一个微微网中，只有一台为主设备（Master），其它均为从设备（Slave），不同的主从设备对可以采用不同的链接方式，在一次通信中，链接方式也可以任意改变。几个相互独立的微微网以特定方式链接在一起便构成了分布式网络。所有的蓝牙设备都是对等的，所以在蓝牙中没有基站的概念。
（8）、工作距离：蓝牙设备分为三个功率等级，分别是：100mW（20dBm）、2.5mW（4dBm）和1mW（0dBm），相应的有效工作范围为：100米、10米和1米。

### 1.2蓝牙的系统构成

![img](https://img-blog.csdn.net/20140726155208535?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveHViaW4zNDE3MTk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

1、无线射频单元(Radio)：负责数据和语音的发送和接收，特点是短距离、低功耗。蓝牙天线一般体积小、重量轻，属于微带天线。
2、基带或链路控制单元(LinkController)：进行射频信号与数字或语音信号的相互转化，实现基带协议和其它的底层连接规程。
3、链路管理单元(LinkManager)：负责管理蓝牙设备之间的通信，实现链路的建立、验证、链路配置等操作。
4、蓝牙软件协议实现：如上图紫色部分。

### 1.3蓝牙协议介绍

传输协议、中介协议、应用协议；
1、传输协议
 负责蓝牙设备间，互相确认对方的位置，以及建立和管理蓝牙设备间的物理链路；
 底层传输协议：
 蓝牙射频（Radio）部分、基带链路管理控制器（Baseband&Link Controller）、链路管理协议（Link ManagerProtocol LMP）。负责语言、数据无线传输的物理实现以及蓝牙设备间的联网组网。
 高层传输协议：
        逻辑链路控制与适配器（LogicalLink Control and Adaptation Protocol）L2CAP 、主机控制接口（HostControl Interface，HCI）。为高层应用屏蔽了跳频序列选择等底层传输操作，为高层程序提供有效、有利于实现数据分组格式。
2、中介协议
    为高层应用协议或者程序，在蓝牙逻辑链路上工作提供必要的支持，为应用提供不同标准接口。
     串口仿真协议：RFCOMM、服务发现协议：SDP、互操作协议IrDA、网络访问协议：PPP、IP、TCP、UDP、电话控制协议：TCS、AT指令集。

3、应用协议

   蓝牙协议栈之上的应用软件和所涉及到的协议，如：拨号上网、语言功能的应用程序。

![img](https://images2015.cnblogs.com/blog/506370/201603/506370-20160308162412288-1389526862.png)

### 1.4硬件接口

一般蓝牙芯片通过UART、USB、SDIO、I2S、PcCard和主控芯片通信。如下图所示，通过UART和主控芯片通信。

![image-20211217172056823](images/image-20211217172056823.png)

## 2.蓝牙协议规范

### 2.1主机控制接口协议HCI

 蓝牙主机-主机控模型 

 ![img](https://img-blog.csdn.net/20140730192808390?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveHViaW4zNDE3MTk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center) 

 蓝牙软件协议栈堆的数据传输过程： 

 ![img](https://img-blog.csdn.net/20140730192844484?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveHViaW4zNDE3MTk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

 

1.蓝牙控制器接口数据分组 **：**指令分组、事件分组、数据分组 。

2.HCI控制命令：控制链路指令、链路策：略指令、主机控制器与基带指令、信息指令参数、状态指令参数、测试指令、错误代码。（上述内容具体可参考： [(11条消息) 蓝牙核心技术概述（四）：蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）_CLK-CSDN博客](https://blog.csdn.net/xubin341719/article/details/38305331) ）

### 2.2 逻辑链路控制与适配协议  L2CAP

 L2CAP位于基带之上，将基带的数据分组转换为便于高层应用的数据分组格式，并提供协议复用和服务质量交换等功能。L2CAP只支持ACL数据传输，不支持SCO数据。
 L2CAP本身不提供加强信道可靠性和保证数据完整性的机制，其信道的可靠性依靠基带提供。  ![img](https://img-blog.csdn.net/20140730194312650?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveHViaW4zNDE3MTk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast) 

1、协议复用：底层传输协议没有提供对高层协议的复用机制，因而L2CAP支持高层协议复用，L2CAP层可以区分其上的SDP、RFCOMM、TCS等。

2、分段重组：L2CAP层帮助实现基带的短PDU和高层的长PDU相互传输，L2CAP本身不完成任何PDU的分段重组，具体的分段重组有低层和高层来完成。

3、服务质量 Qualityof Serivce 信息的交换：蓝牙建立连接的过程中，L2CAP允许交互蓝牙所期望的服务质量，建立完成后，通过监视资源的使用情况，来保证服务质量。

4、组抽象：L2CAP忽略地址组概念，他只关心数据。

### 2.3服务协议SDP

 SDP两种服务发现模式： 
 **1）、服务搜索：**查询具有特定服务属性的服务；  
 **2）、服务浏览：**简单的浏览全部可用服务。 

### 2.4串口仿真协议RFCOMM

为建立在串口之上的传统应用提供环境接口，使他们可以做比较少协议改动就可以在蓝牙无线通信无线链路上工作。多路串口仿真是RFCOMM的重要功能，通过多路复用器(multiplexer)，一条L2CAP链路可以同时 多个串行应用。
 两台设备间的串口仿真: 	

 ![img](https://img-blog.csdn.net/20140730195839495?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveHViaW4zNDE3MTk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast) 

 RFCOMM 两个蓝牙设备之间可以支持多达60多路仿真串口。 

**RFCOMM帧类型如下：**

| SABM | 异步平衡模式设置指令           |
| ---- | ------------------------------ |
| UA   | 未加编号的确认响应             |
| DM   | 断开连接模式响应               |
| DISC | 断开连接指令                   |
| UIH  | 带头校验的未编号信息命令和响应 |

## 3.蓝牙软件开发

本章介绍的是蓝牙低功耗BLE的开发流程。 蓝牙低功耗是从蓝牙 4.0 起支持的协议，与经典蓝牙相比，功耗极低、传输速度更快，但传输数据量较小。常用在对续航要求较高且只需小数据量传输的各种智能电子产品中，比如智能穿戴设备、智能家电、传感器等，应用场景广泛。 

### 3.1角色/工作模式

 蓝牙低功耗协议给设备定义了若干角色，或称工作模式 。

#### 1) 中心设备/主机 (Central)

中心设备可以扫描外围设备，并在发现有外围设备存在后与之建立连接，之后就可以使用外围设备提供的服务（Service）。

一般而言，手机会担任中心设备的角色，利用外围设备提供的数据进行处理或展示等等。

#### 2) 外围设备/从机 (Peripheral)

外围设备一直处于广播状态，等待被中心设备搜索和连接，不能主动发起搜索。例如智能手环、传感器等设备。

如果外围设备广播时被设置为不可连接的状态，也被称为广播模式 (Broadcaster)，常见的例子是[蓝牙信标 (Beacon)](https://developers.weixin.qq.com/miniprogram/dev/framework/device/beacon.html) 设备。

### 3.2通信协议

在两个蓝牙低功耗设备建立连接之后，双方的数据交互是基于 GATT (Generic Attribute Profile) 规范，根据该规范可以定义出一个个配置文件 (Profile)，描述该蓝牙设备提供的服务 (Service)。

在整个通信过程中，有几个最主要的概念：

- **配置文件 (Profile)**: Profile 是被蓝牙标准预先定义的一些 Service 的集合，并不真实存在于蓝牙设备中。如果蓝牙设备之间要相互兼容，它们只要支持相同的 Profile 即可。一个蓝牙设备可以支持多个 Profile。
- **服务 (Service)**: Service 是蓝牙设备对外提供的服务，一个设备可以提供多个服务，比如电量信息服务、系统信息服务等。每个服务由一个 UUID 唯一标识。
- **特征 (Characteristic)**: 每个 Service 包含 0 至多个 Characteristic。比如，电量信息服务就会有个 Characteristic 表示电量数据。Characteristic 包含一个**值 (value)\**和 0 至多个\**描述符 (Desciptor)** 组成。**在与蓝牙设备通信时，主要就是通过读写 Characteristic 的 value 完成。** 每个 Characteristic 由一个 UUID 唯一标识。
- **描述符 (Desciptor)**: Desciptor 是描述特征值的已定义属性。例如，Desciptor 可指定人类可读的描述、特征值的取值范围或特定于特征值的度量单位。每个 Desciptor 由一个 UUID 唯一标识。

如下图所示，我们可以简单地理解为：每个蓝牙设备可能提供多个 Service，每个 Service 可能有Characteristic，我们根据蓝牙设备的协议对对应 Characteristic 的值进行读写即可达到与其通信的目的。

 ![GATT](https://res.wx.qq.com/wxdoc/dist/assets/img/gatt.eed11385.jpeg) 

#### UUID (Universally Unique Identifier)

根据蓝牙 4.2 协议规范(Vol 3, Part B, section 2.5.1 UUID)，UUID 是一个 128 位的唯一标识符，用来标识 Service 和 Characteristic 等。

为了减少存储和传输 128 位 UUID 值的负担，蓝牙技术联盟预分配了一批 UUID，这一批 UUID 拥有一个共同部分，被称为 Bluetooth Base UUID，即 `00000000-0000-1000-8000-00805F9B34FB`。因此，预分配的 UUID 也可以使用 16 位或 32 位表示，其中 16 位 UUID 最为常用。使用 16/32 位的 UUID 可以降低存储和传输的负载。开发者自定义的 UUID 应注意不能与预分配的 UUID 冲突。

- iOS 支持直接使用 16 位 和 128 位的 UUID；

- Android 8.0.9 版本开始，支持直接使用 16/32/128 位 UUID；

- Android 8.0.9 以下版本，只支持 128 位的 UUID，需要开发者手动补位到 128 位。补位方式如下

  ```text
  128位UUID = 16位UUID * 2^96 + Bluetooth Base UUID
  128位UUID = 32位UUID * 2^96 + Bluetooth Base UUID
  ```

  例如

  ```text
  0x180F -> 0000180F-0000-1000-8000-00805F9B34FB
  ```

所有接口的返回值统一为 128 位 UUID。

### 3.3中心设备使用流程

#### 1）初始化蓝牙模块

在使用蓝牙接口前，必须首先 初始化蓝牙适配器模块，其他接口必须在初始化后成功方可调用。 

#### 2）扫描并发现蓝蓝牙外围设备

蓝牙模块初始化成功后，一般需要扫描外围设备。当蓝牙外围设备被扫描到时，会回调发现事件，返回扫描到的设备。扫描设备比较耗费系统资源，请在搜索到需要的设备后及时停止搜索 。若之前已连接过某个设备，获取到了 deviceId，可跳过扫描步骤。

#### 3）连接设备

蓝牙低功耗设备间要进行通信，必须首先建立连接。 

#### 4）获取蓝牙外围服务

#### 5）读取服务的特征值

#### 6）断开连接和关闭蓝牙设配器